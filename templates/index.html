<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tim's Print Shop - Upload POC</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .container { display: flex; gap: 2rem; flex-wrap: wrap; }
        .controls { flex: 1; min-width: 300px; }
        .preview-area { flex: 1; min-width: 300px; position: relative; }
        
        /* Overlay Logic */
        .image-wrapper { position: relative; display: inline-block; border: 1px solid #ccc; max-width: 100%; }
        .preview-img { display: block; max-width: 100%; height: auto; }
        
        /* The Bleed/Safe Zones - These are CSS overlays */
        .overlay-bleed {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border: 4px solid red; /* Represents the cut line risk */
            pointer-events: none; display: none;
        }
        .overlay-safe {
            position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 2px dashed green; /* Safe zone */
            pointer-events: none; display: none;
        }
        
        .status-box { margin-top: 1rem; padding: 1rem; border-radius: 4px; display: none; }
        .status-good { background: #d4edda; color: #155724; }
        .status-bad { background: #f8d7da; color: #721c24; }
        
        button { background: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; margin-top: 10px; }
        button:disabled { background: #ccc; }
        input, select { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }
        label { font-weight: bold; display: block; margin-top: 10px;}
    </style>
</head>
<body>

<h1>Tim's Print Shop: Upload Portal</h1>

<div class="container">
    <div class="controls">
        <label>1. Contact Info</label>
        <input type="text" id="name" placeholder="Full Name">
        <input type="email" id="email" placeholder="Email Address">

        <label>2. Select Size (Inches)</label>
        <select id="sizeSelect" onchange="checkQuality()">
            <option value="" disabled selected>Select a size...</option>
            {% for name, dims in sizes.items() %}
            <option value="{{ dims[0] }},{{ dims[1] }}">{{ name }} ({{ dims[0] }}" x {{ dims[1] }}")</option>
            {% endfor %}
        </select>

        <label>3. Upload Artwork (JPG, PDF, HEIC)</label>
        <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.pdf,.heic">
        
        <div id="statusBox" class="status-box"></div>
        
        <button id="submitBtn" onclick="submitOrder()" disabled>Submit Order</button>
    </div>

    <div class="preview-area">
        <label>Preview (Red = Bleed, Green = Safe Zone)</label>
        <div class="image-wrapper" id="imgWrapper">
            <img id="preview" class="preview-img" src="" style="display:none;">
            <div id="bleed" class="overlay-bleed"></div>
            <div id="safe" class="overlay-safe"></div>
        </div>
    </div>
</div>

<script>
    let currentWidthPx = 0;
    let currentHeightPx = 0;
    let currentFilename = "";

    // Handle File Upload and Conversion
    document.getElementById('fileInput').addEventListener('change', async function() {
        const file = this.files[0];
        if(!file) return;

        const formData = new FormData();
        formData.append('file', file);

        document.getElementById('statusBox').style.display = 'block';
        document.getElementById('statusBox').className = 'status-box';
        document.getElementById('statusBox').innerText = "Processing/Converting... please wait.";

        try {
            const response = await fetch('/upload', { method: 'POST', body: formData });
            const data = await response.json();

            if(data.error) {
                alert(data.error);
                return;
            }

            // Update Preview
            const img = document.getElementById('preview');
            img.src = data.url;
            img.style.display = 'block';
            document.getElementById('bleed').style.display = 'block';
            document.getElementById('safe').style.display = 'block';
            
            // Store real pixel data for calculation
            currentWidthPx = data.width;
            currentHeightPx = data.height;
            currentFilename = data.filename;

            checkQuality();

        } catch (err) {
            console.error(err);
            alert("Error uploading file.");
        }
    });

    // Quality Check (DPI Logic)
    function checkQuality() {
        const sizeVal = document.getElementById('sizeSelect').value;
        if (!sizeVal || currentWidthPx === 0) return;

        const [widthInch, heightInch] = sizeVal.split(',').map(Number);
        
        // Calculate DPI
        const dpiX = currentWidthPx / widthInch;
        const dpiY = currentHeightPx / heightInch;
        const effectiveDPI = Math.min(dpiX, dpiY); // Take the worst case
        
        const statusBox = document.getElementById('statusBox');
        const submitBtn = document.getElementById('submitBtn');

        statusBox.style.display = 'block';

        if (effectiveDPI >= 225) {
            statusBox.className = 'status-box status-good';
            statusBox.innerText = `Quality Great! Detected DPI: ${Math.round(effectiveDPI)}. Accepted.`;
            submitBtn.disabled = false;
        } else {
            statusBox.className = 'status-box status-bad';
            statusBox.innerText = `Quality Low. Detected DPI: ${Math.round(effectiveDPI)}. Minimum 225 required.`;
            submitBtn.disabled = true;
        }
    }

    // Submit Order
    async function submitOrder() {
        const email = document.getElementById('email').value;
        if(!email) { alert("Please enter email"); return; }

        const response = await fetch('/submit-order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                email: email,
                filename: currentFilename,
                size: document.getElementById('sizeSelect').value
            })
        });
        const res = await response.json();
        alert(res.message);
    }
</script>

</body>
</html>
